<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="hqna">
	<insert id="insertHqna" parameterType="com.sp.hqna.Hqna">
		INSERT INTO question(qnaCode, catCode, userIdx, subject, content)
			VALUES(question_seq.NEXTVAL, 2, #{userIdx}, #{subject}, #{content} )	
	</insert>
	
	<sql id="where-list">
		<choose>
			<when test="key=='all'">
				(INSTR(subject, #{value}) &gt; 0
					OR DBMS_LOB.INSTR(content, #{value}) &gt; 0)
			</when>
			<when test="key=='created'">
				(TO_CHAR(created, 'YYYY-MM-DD') = #{value}
					OR TO_CHAR(created, 'YYYYMMDD') = #{value})
			</when>
			<when test="key=='content'">
				DBMS_LOB.INSTR(content, #{value}) &gt; 0
			</when>
			<otherwise>
				INSTR(${key}, #{value}) &gt; 0
			</otherwise>
		</choose>
	</sql>
	
	<select id="dataCount" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(*), 0)
		FROM question
		join tb_user on question.userIdx=tb_user.userIdx
		<where>
			<if test="value != null and value !=''">
				<include refid="where-list"/>
			</if>		
		AND catCode = 2
		</where>
	</select>
	
	<select id="listHqna" parameterType="map" resultType="com.sp.hqna.Hqna">
		SELECT * FROM (
		    SELECT ROWNUM rnum, tb.* FROM (
					SELECT q.qnaCode, q.userIdx, subject, hitCount, 
		            TO_CHAR(created, 'YYYY-MM-DD')created, q.catCode
		            ,userName, NVL(answerCount, 0) answerCount
		          
		            FROM question q
		            LEFT OUTER JOIN answer a ON q.qnaCode=a.qnaCode
		            JOIN tb_user u ON u.userIdx=q.userIdx
		            
		            LEFT OUTER JOIN(
		            	SELECT qe.qnaCode, COUNT(*) answerCount
		            	FROM question qe
		            	JOIN answer an
		            	ON qe.qnaCode=an.qnaCode
		            	GROUP BY qe.qnaCode
		            ) qe ON qe.qnaCode=q.qnaCode
		            <where>
						<if test="value != null and value !=''">
							<include refid="where-list"></include>
						</if>		
		           	AND catCode =2
					</where>
		            ORDER BY qnaCode DESC
<![CDATA[
		    ) tb WHERE ROWNUM <= #{end}
		) WHERE rnum >= #{start}
]]>			
	</select>
	
	<update id="updateHitCount" parameterType="Integer">
		UPDATE question SET hitCount=hitCount+1 WHERE qnaCode=#{qnaCode}
	</update>
	
	<select id="readHqna" parameterType="Integer" resultType="com.sp.hqna.Hqna">
	SELECT qnaCode, u.userName, subject, content, hitCount, created
	FROM question q
	JOIN tb_user u ON u.userIdx=q.userIdx
	WHERE qnaCode=#{qnaCode}
	</select> 
	
	<select id="preReadHqna" parameterType="map" resultType="com.sp.hqna.Hqna">
		SELECT tb.*FROM (
			SELECT qnaCode, subject
			FROM question q
			JOIN tb_user u ON u.userIdx=q.userIdx
			<where>
			<if test="value != null and value !=''">
				<include refid="where-list"/>
			</if>
			AND qnaCode &gt; #{qnaCode}
			</where>
				ORDER BY qnaCode ASC
		)tb WHERE ROWNUM=1
	</select>
	
	<select id="nextReadHqna" parameterType="map" resultType="com.sp.hqna.Hqna">
		SELECT tb.*FROM (
			SELECT qnaCode, subject
			FROM question q
			JOIN tb_user u ON u.userIdx=q.userIdx
			<where>
			<if test="value !=null and value !=''">
				<include refid="where-list"/>
			</if>
			AND qnaCode &lt; #{qnaCode}
			</where>
				ORDER BY qnaCode DESC
		)tb WHERE ROWNUM=1
	</select>
	
	<update id="updateHqna" parameterType="com.sp.hqna.Hqna">
		UPDATE question SET subject=#{subject}, content=#{content, jdbcType=CLOB} WHERE qnaCode=#{qnaCode}
	</update>
	
	<delete id="deleteHqna" parameterType="Integer">
		DELETE FROM question WHERE qnaCode=#{qnaCode}
	</delete>
	
	<select id="listReply" parameterType="map" resultType="com.sp.hqna.Reply">
		SELECT answerCode, qnaCode, answerContent, answerCreated, adminIdx FROM answer 	WHERE qnaCode=#{qnaCode}
	</select>	
</mapper>